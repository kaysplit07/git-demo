resource "azurerm_network_interface" "nic1" {
  provider = azurerm.adt
  for_each = { for row_id, inst in local.final_parms_map : row_id => inst }
  location            = local.naming.location
  name                = (each.value).nic_name_1
  resource_group_name = (each.value).rg_name

  ip_configuration {
    name                          = join("-", [(each.value).vm_name, "nic1_config" ])
    subnet_id                     = data.azurerm_subnet.nic1[each.key].id
    private_ip_address_allocation = "Dynamic"

    # Associate NIC with load balancer's backend address pool
    load_balancer_backend_address_pools_ids = [azurerm_lb_backend_address_pool.internal_lb_bepool[each.key].id]
  }
}

resource "azurerm_network_interface" "nic2" {
  provider = azurerm.adt
  for_each = { for row_id, inst in local.final_parms_map : row_id => inst }
  location            = local.naming.location
  name                = (each.value).nic_name_2
  resource_group_name = (each.value).rg_name

  ip_configuration {
    name                          = join("-", [(each.value).vm_name, "nic2_config" ])
    subnet_id                     = data.azurerm_subnet.nic2[each.key].id
    private_ip_address_allocation = "Dynamic"

    # Associate NIC with load balancer's backend address pool
    load_balancer_backend_address_pools_ids = [azurerm_lb_backend_address_pool.internal_lb_bepool[each.key].id]
  }
}
