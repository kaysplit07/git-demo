resource "azurerm_network_interface_backend_address_pool_association" "lb_backend_association" {
  for_each = {
    for idx, pool in azurerm_lb_backend_address_pool.internal_lb_bepool : idx => {
      pool_id = pool.id
      nic_id  = data.azurerm_network_interface.nic[idx].id
      vm_name = local.vm_names_list[idx]
    } if idx < length(local.vm_names_list) # Ensure we don't exceed vm_names_list length
  }

  network_interface_id    = each.value.nic_id
  ip_configuration_name   = join("-", [each.value.vm_name, "nic1_config"])
  backend_address_pool_id = each.value.pool_id
}
