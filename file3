#!/bin/bash

# Namespace
NAMESPACE="cobalt"

# Output file
OUTPUT_FILE="feb5-pp4-ca-cert10.bkp.yml"

# List of secret names
SECRETS=("ca-cert10" "ca-cert11" "ca-cert12")  # Add more as needed

# Clear the output file before appending
> "$OUTPUT_FILE"

# Iterate through the list of secrets
for SECRET in "${SECRETS[@]}"; do
    echo "Processing $SECRET..."

    # Extract the Base64-encoded certificate(s) from the secret
    CERTS_BASE64=$(kubectl get secret "$SECRET" -n "$NAMESPACE" -o jsonpath="{.data.tls\.crt}")

    # Check if the secret contains certificates
    if [[ -n "$CERTS_BASE64" ]]; then
        echo -e "\n---\n$SECRET:" >> "$OUTPUT_FILE"
        
        # Decode and process each certificate
        echo "$CERTS_BASE64" | base64 -d | awk '
            BEGIN { cert_count=0; }
            /-----BEGIN CERTIFICATE-----/ { cert_count++; print "---\nCertificate #" cert_count ":" }
            { print }
        ' >> "$OUTPUT_FILE"

        echo -e "\n---\n" >> "$OUTPUT_FILE"  # Separator for readability
    else
        echo "Warning: No certificate found for $SECRET"
    fi
done

echo "Backup complete. Output saved in $OUTPUT_FILE."
