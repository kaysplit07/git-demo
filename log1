#!/bin/bash

# Input file containing multiple PEM certificates
input_file="allcerts-base64d-unique.txt"

# Get the current date in seconds (UNIX timestamp)
current_date=$(date +%s)

# Temporary variable to store each certificate
cert_content=""
cert_found=false
cert_count=0

# Read the input file line by line
while IFS= read -r line || [[ -n "$line" ]]; do
    if [[ "$line" == "-----BEGIN CERTIFICATE-----" ]]; then
        cert_found=true
        cert_content="$line"
    elif [[ "$line" == "-----END CERTIFICATE-----" ]]; then
        cert_content+="\n$line"

        # Extract the expiration date of the certificate
        expiry_date=$(echo -e "$cert_content" | openssl x509 -enddate -noout 2>/dev/null | cut -d= -f2)
        expiry_timestamp=$(date -d "$expiry_date" +%s 2>/dev/null)

        # Check if expiry date conversion was successful
        if [[ -n "$expiry_timestamp" ]]; then
            if [[ "$expiry_timestamp" -lt "$current_date" ]]; then
                echo "Cert expired on $expiry_date and not saved"
            else
                ((cert_count++))
                cert_filename="cert${cert_count}.pem"
                echo "Cert is valid until $expiry_date and saved as $cert_filename"
                echo -e "$cert_content" > "$cert_filename"
            fi
        else
            echo "Could not determine expiry date. Skipping certificate."
        fi

        cert_content=""
        cert_found=false
    else
        if $cert_found; then
            cert_content+="\n$line"
        fi
    fi
done < "$input_file"
